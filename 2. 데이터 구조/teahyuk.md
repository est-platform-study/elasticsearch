# Elastic search 데이터 구조

## 데이터 구조
---

1. 인덱스 : 예전엔 Database와 같게보았으나 요즘은 RDBMS의 테이블과 매치됨
2. 타입 : Deprecated됨, 이전 소개부분 참조
3. 도큐먼트 : Row
4. 필드 : 각 도큐먼트의 키? 라고 볼 수 있음.

### 역색인 방식

검색을 위해 indexing이 완료 되면 데이터는 먼저 각 매핑 된 방식에 따라 각 키워드 별로 해당되는 document의 id가 저장되는 방식으로 저장됨.

서로 겹치지 않는 형태소, 키워드 등으로 저장되면 2배 이상 씩 용량을 잡아먹지만 겹치는 키워드들이 많을 수 있으므로 모든 데이터에 대해서 2배 이상씩 잡아먹지 않음.

또 매핑 방식, 또는 저장 방식에 따라서 rawData 저장 안 할 수도 있음.



## 데이터 수집, indexing
---

### 공통
- `_`가 붙으면 메타데이터(내장필드) 또는 elasticSearch쪽 명령을 사용하게 된다.
- url param에 `pretty`를 붙이면 json이 이쁘게 정렬되서 나옴
- `@`를 이용하면 파일을 입력값으로 사용 가능하다.

### 데이터 입력

- RestAPI를 사용한다
- Post로 create, PUT으로 업데이트를 한다,,, 고 나와있지만 둘 다 된다 구분 없다.
- 둘다 없으면 입력 있으면 업데이트로 대체한다.
- 업데이트에는 remove에걸리는 시간이 상당하며,메타데이터(_version)이 증가한다.
    - 이전데이터를 확인할 순 없지만 용량은 잠시 늘어날 수 있다.
- document id를 입력안하면 임의의 id가 생성된다.
    - 단 PUT으로는 생성이 안된다. POST로 해야한다.
- 업데이트는 사실상 삭제 후 재 입력이라서 값이 높다.

### 데이터 삭제

- 삭제는 즉시 삭제가 아니다.
- 마킹 후 검색 안되게 막는다.
- 메타 데이터는 남아있어서 같은 id로 다시 입력하게되면 _version이 올라간다.

### 데이터 업데이트

- '_update'명령을 사용한다.
- 내부 동작 방식은 'GET'으로 가져와서 확인 후 script결과에 맞게 다시 'POST'하는 방식으로 동작한다.
- script로 MVEL 문법을 사용해서 변경 가능하다.

### bulk

- 대용량 데이터를 한꺼번에 insert할 때 필요하다.
- 메타데이터한줄 다음 실제 데이터 한줄 이런 식으로 동작한다.
- doc개수는 1000~5000개가 좋고 10,000 개 넘어가면 오류가능성이 있다.
- udp를 통해 bulk로 받을 수도 있다.


## 매핑
---

indexing을 위한 매핑 방식을 정의 하는 방법론.

- index 생성 과 함께 매핑 설정 가능
- 매핑 설정 안해도 자동 설정 됨.
- 매핑에 필드 추가는 가능하지만 변경 삭제는 불가능함.
- mapping 삭제를 시도하면 데이터가 다 날라간다고 책에서 설명한다
    - 하지만 DELETE 메소드 자체가 응답 안되도록 에러를 날리게됨.

### 내장필드 매핑

- `_`로 시작하는 엘라스틱서치에서 각 document의 메타데이터와 같은 내부 기능들을 설명한 필드들이다.

#### `_id`

- document id를 나타냄

##### 옵션

1. index : 색인 여부 (default false)
2. store : 저장 여부 (default false)
3. path : 내부 필드 중 한가지로 자동 id 매핑

#### `_source`

- 원본데이터 저장되는 내장필드

##### 옵션

1. enabled : 전체 raw data 저장여부
2. includes : 저장 포함할 필드
3. excludes : 저장 제외할 필드

#### `_all`

- 검색할 대상 필드 지정용 내장필드

##### 옵션

1. enabled : `_all` 사용여부
2. 각 properties 의 필드 중 inculde_in_all : 색인 사용 여부

#### `_analyzer`

- 분석기사용 내장필드

#### `_timestamp`

- document저장 된 시간의 타임스탬프

##### 옵션

1. enabled : 사용여부
2. store : 저장 여부
